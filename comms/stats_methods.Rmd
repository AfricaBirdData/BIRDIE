---
title: "Statistical and Technical Methods in BIRDIE (DRAFT)"
author: "Francisco Cervantes"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output: pdf_document
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "output") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Introduction

This document provides details on the statistical models and used in the data pipeline and their implementation.

# Abundance and population trends

## State-space models

State-space models are used to describe and understand dynamic systems that may not be perfectly observed. Within this framework, we consider a process of interest that evolves over time, and which we may observe at certain occasions,  although distorted by some imperfect observation process. For example, we might be interested in estimating the number of birds present at a certain site, but often field observers will miss some individuals. By counting repeatedly over time, and assuming that the process of interest evolves slowly compared to observation error, we can disentangle these two processes.

Here, we are interested in estimating bird abundance using counts from the Coordinated Waterbird Counts (CWAC) project (see relevant section for details). CWAC provides data on counts ($y_i$) at a number of sites. We consider that the observed counts at time $i$, at any given site, arise from a Poisson($\lambda_i$) process.

$$y_i \sim \textrm{Poisson}(\lambda_i)$$

We model the log of the intensity $\lambda_i$ as:

$$\log{(\lambda_i)} \sim N(\mu_i, \sigma^2)$$
where $\mu_i$ is the log mean abundance of waterbirds on site and $\sigma^2$ is the variance of the observer count error in the log scale. Therefore, the counts on sampling occasion $i$ depend both on the number of waterbirds present, and on errors in the counts of these birds.

To model changes in waterbird abundance between the two-seasons of year $t$, we define $s_t$ as the summer abundance and $w_t$ as the winter abundance. Note that there might be multiple counts in a single year and season, but the underlying true abundance is considered to stay constant in any given year and season (note also that counts were indexed by $i$, and year are indexed by $t$). Thus, the expected (log) abundance for any given count can be written as

$$\mu_{i} = s_t \textrm{summer} + w_t \textrm{winter}$$
where 'summer' is a dummy variable that takes on the value 1 in summer and 0 in winter, and 'winter' is the opposite.

We then define abundance dynamics as:

$$s_t = s_{t-1} + \beta_t$$
$$w_t = s_t + \xi_t$$

where $\beta_t$ corresponds to the change in summer abundance from year $t-1$ to year $t$, and $\xi_t$ is the difference between summer and winter abundance, both in the log scale. If exponentiated, these parameters can be interpreted as the rate of change in the population and the winter-to-summer ratio of the population, respectively.

We impose relatively smooth changes in abundance by defining autocorrelation in $\beta_t$ and $\xi_t$ terms over time. In addition, we define relationships between the rate of change in the population $\beta_t$ and environmental covariates. These relationships facilitate the estimation of abundance for those years in which counts are missing, and it is particularly useful to contain uncertainty in long periods with missing data between counts. Thus, we set

$$\beta_{t+1} = \phi\beta_t + \eta_t + \zeta_t$$
$$\xi_{t+1} = \xi_t + \epsilon_t$$

where $\phi$ lies between zero and one, and it defines an autoregressive term on $\beta_{t-1}$; $\eta_t$ captures the effect of covariates in the expected change in abundance, and can be expanded to $\gamma^{\intercal}\mathrm{U}$, where $\mathrm{U}$ is a matrix of covariate values and $\gamma$ a vector of coefficients; $\zeta_t$ and $\epsilon_t$ are random variables that represent change in abundance change, and change in winter to summer ratio, respectively.

We mentioned at the beginning that this model applies to each monitored site. However, we have multiple sites, and counts are often missing for some seasons or even full years. To facilitate the estimation of abundance with missing data, we borrow information from sites with counts, by defining a hierarchical structure such that:

$$\zeta_{tj} \sim N(0, \sigma^2_{\zeta t})$$
$$\epsilon_{tj} \sim N(0, \sigma^2_{\epsilon t})$$
so that random changes at any site $j$ and year $t$ come from a common distribution of changes across all sites for that year. These distributions are normal with variances $\sigma^2_{\zeta t}$ and $\sigma^2_{\epsilon t}$ for changes in abundance and winter to summer ratio, respectively.

### Implementation:

At the moment this state-space model is fitted in `R` with the package `jagsUI` that uses `rjags`. We have written a few functions in `BIRDIE` to make fitting and plotting output from these models easy. The basic workflow to fit this model to a species at a certain site (we use Barberspan as an example) is the following:

```{r, eval=FALSE, echo=TRUE}

# Load data (Barberspan example)
counts <- BIRDIE::barberspan

# Select a species (ADU code)
sp <- 83

# Prepare data to fit an SSM
ssmcounts <- BIRDIE::prepSsmData(counts, species = sp)

# Fit 2-season dynamic trend model
fit_dyn <- BIRDIE::fitCwacSsm(ssmcounts, mod_file = BIRDIE::writeJagsModelFile(),
                              param = c("beta", "lambda", "sig.zeta", "sig.w",
                                        "sig.eps", "sig.alpha", "sig.e", "mu_t", "mu_wt"))
```

We can then create plots and prepare data to export to use in the dashboard by doing:


```{r, eval=FALSE, echo=TRUE}

# Plot
pers_theme <- ggplot2::theme_bw()
p <- BIRDIE::plotSsm2ss(fit = fit_dyn, ssm_counts = ssmcounts, dyn = TRUE,
                        plot_options = list(pers_theme = pers_theme,
                                            colors = c("#71BD5E", "#B590C7")))

plot(p$plot)
```

There is also a function that allows us to fit a model and produce output for all the species detected at a certain site at once to facilitate automation:


```{r, eval=FALSE, echo=TRUE}

# Load data (Barberspan example)
counts <- BIRDIE::barberspan

# Fit all species and save data outputs and plots to "analysis/out_nosync/".
BIRDIE::loopSsmAllSpp(barberspan, data_outdir = "analysis/out_nosync/",
                      plot_outdir = "analysis/out_nosync/",
                      param = c("beta", "lambda", "sig.zeta", "sig.w", "sig.eps",
                                "sig.alpha", "sig.e", "mu_t", "mu_wt"),
                      jags_control = list(ncores = 3))
```

# Species distribution

## Occupancy modelling

Occupancy models are fitted to detection/non-detection data from the Southern Africa Bird Atlas Project (SABAP) to delineate the distribution of waterbird species and its dynamics over time.  Within the SABAP2 framework, observers visit pentads and make a list of the bird species detected during the visit.We assume that observers donâ€™t misidentify species or otherwise list species that were not actually detected (the rigorous vetting process of SABAP2 data justifies this assumption), but non-detections may be caused by either the species not being present in the pentad or by the observers not being able to detect it, although it was present. Therefore, occupancy models describe two processes simultaneously: i) the underlying occupancy of the sites (pentads), and ii) the observation process whereby species present might or might not be observed.

More precisely, we define $z_{jt}$ to be the true occupancy of site $j$ in year $t$, which can be 1 (if species present) or 0 (if species absent) and has distribution:

$$z_{jt}|\psi_{jt} \sim \textrm{Bernoulli}(\psi_{jt})$$,

where $\psi_{jt}$ is the occupancy probability at site $j$ and year $t$. The logit transformation of $\psi_{jt}$ can be modelled as a linear combination of covariates and smooth functions of covariates, such that:

$$\textrm{logit}(\psi_{jt}) = \boldsymbol{x}_{jt}^\intercal \boldsymbol{\beta} + \sum_{k=1}^K f_k(u_{jk})$$

where $u_{jk}$ is a smooth function of the covariate $u_k$, which is defined as

$$f_k(u_{jk}) = \sum_{l=1}^L \textrm{B}_l(u_{jkl})\gamma_{jkl}$$

where the smooth function $f$ is represented by a set of $L$ basis functions $\textrm{B}_l$ evaluated at the value of the covariates associated with site $j$ at year $t$.

Then, the probability of detection of a species that is present in site $j$ on visit $i$ is denoted by $p_{ij}$. Following the same logic as for the probability of occupancy, the logit transformation of $p$ is modelled as a linear combination of covariates and smooth functions:

$$\textrm{logit}(p_{ij})= \boldsymbol{w}_{ij}^\intercal \boldsymbol{\alpha} + \sum_{h=1}^H f_h(v_{ih})$$,

Finally, the likelihood of observation $y_{ij}$ can be written as:

$$y_{ij}|z_{jt},p_{ij} \sim \textrm{Bernoulli}(z_{jt}p_{ij})$$

Spatial, spatio-temporal, and unstructured random effects can be specified for either occupancy or detection probabilities to account for variation across sites, observers and visits, not accounted for by the covariates incorporated in the models.

Each checklist is treated as an independent survey, but occupancy is assessed on a yearly basis. This means that if a species is detected in any one survey it is considered present that year. Therefore, missing a species because it left the site is considered part of the observation process and not the occupancy process.

At the moment, we are fitting models to three years of SABAP2 data, and using spatio-temporal random effects for the occupancy probability of pentads with an exponential decay function. With this procedure indicators for any one year are estimated several times, due to several 3-year windows overlapping the same year. We keep the estimate from the model that has the year of interest in the centre of the window, because it should be the most precise. We also incorporate random effects to account for pentad- and observer-specific detection probabilities. However, these modelling details may differ among species and may be updated in the future.



## Implementation

We use the functionality provided by the `R` package developed by Richard Glennie `occuR`. We have also created functions in the `BIRDIE` package to simplify this process and facilitate automation. The basic workflow entails:

- Defining a region and a species of interest we want to estimate occupancy for.

```{r, eval=FALSE, echo=TRUE}
library(BIRDIE)

# SABAP code for the species of interest
sp_sel <- 6

# Region of interest
region <- "South Africa"

```

- Next we need to extract all pentads in the region and annotate them with covariates. Currently we are using climatic covariates provided by the TerraClimate data set and the surface water dataset provided by the European Commission Joint Research Centre.


```{r, eval=FALSE, echo=TRUE}

# Set up multicore
future::plan("multisession", workers = 6)

sites <- prepOccSiteData(region = region,
                         years = 2008:2011,
                         clim_covts = c("prcp", "tmax", "tmin", "aet", "pet"),
                         covts_dir = "analysis/downloads/",
                         file_fix = c("terraClim_", "_03_19"),
                         savedir = "analysis/data/pentads_sa.rds")

future::plan("sequential")

```

- Next, we need to prepare occupancy records for the selected pentads. For this, we download data from the SABAP project and annotate this records with covariates.


```{r, eval=FALSE, echo=TRUE}

# Set up multicore
future::plan("multisession", workers = 6)

pa_dat <- prepOccVisitData(region = "South Africa",
                           sites = sites,
                           species = sp_sel,
                           years = 2008:2011,
                           clim_covts = c("prcp", "tmax", "tmin", "aet", "pet"),
                           covts_dir = "analysis/downloads/",
                           file_fix = c("terraClim_", "_03_19"),
                           savedir = "analysis/data/pentads_sa.rds")

future::plan("sequential")

```

- With these two elements we are ready to fit an occupancy model with `occuR`:


```{r, eval=FALSE, echo=TRUE}

# First, we need to give data the correct format
occuRdata <- prepDataOccuR(sitedata, visitdata)

# Fit occupancy model (e.g. smooth for spatial effect on psi)
fit <- fit_occu(list(psi ~ 1 + prcp + log(water+0.1) +
                         t2(lon, lat, occasion, k = c(25, 3), bs = c("ts", "cs"), d = c(2,1)),
                     p ~ 1 + log(TotalHours+0.1) + s(month, bs = "cs")),
                visit_data = occuRdata$visit,
                site_data = occuRdata$site)


```

