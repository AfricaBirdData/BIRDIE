<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>BIRDIE: Species abundance â€¢ BIRDIE</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="BIRDIE: Species abundance">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">BIRDIE</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v01-birdie-basics.html">BIRDIE: Basics</a></li>
    <li><a class="dropdown-item" href="../articles/v02-birdie-spp-abundance.html">BIRDIE: Species abundance</a></li>
    <li><a class="dropdown-item" href="../articles/v03-birdie-spp-distributions.html">BIRDIE: Species distributions</a></li>
    <li><a class="dropdown-item" href="../articles/v04-birdie-abu-data-prep.html">BIRDIE ABU: Data preparation</a></li>
    <li><a class="dropdown-item" href="../articles/v05-birdie-abu-model-fitting.html">BIRDIE ABU: Model fitting</a></li>
    <li><a class="dropdown-item" href="../articles/v06-birdie-abu-model-diagnostics.html">BIRDIE ABU: Model diagnostics</a></li>
    <li><a class="dropdown-item" href="../articles/v07-birdie-abu-model-summary.html">BIRDIE ABU: Model summary</a></li>
    <li><a class="dropdown-item" href="../articles/v08-birdie-dst-data-prep.html">BIRDIE DST: Data preparation</a></li>
    <li><a class="dropdown-item" href="../articles/v09-birdie-dst-model-fitting.html">BIRDIE DST: Model fitting</a></li>
    <li><a class="dropdown-item" href="../articles/v10-birdie-dst-diagnostics.html">BIRDIE DST: Model diagnostics</a></li>
    <li><a class="dropdown-item" href="../articles/v11-birdie-dst-model-summary.html">BIRDIE DST: Model summary</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>BIRDIE: Species abundance</h1>
            
      

      <div class="d-none name"><code>v02-birdie-spp-abundance.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>There are two main analytical modules in BIRDIE: distribution and
abundance.</p>
<p>In this document we will see how to use the abundance (ABU) module.
To do this we will have a look at the control script used to run the
module and then we will break down its different sections to understand
what all the functions involved in this analysis do.</p>
</div>
<div class="section level2">
<h2 id="the-control-script">The control script<a class="anchor" aria-label="anchor" href="#the-control-script"></a>
</h2>
<p>The control script can be found at
<code>/analysis/scripts/pipeline_script_abu.R</code>. This script has
three parts:</p>
<ul>
<li>Configuration</li>
<li>Create logs</li>
<li>Run modules</li>
</ul>
<p>We will go through each of these parts below.</p>
<p>The script is really just a for loop over species in which the main
pipeline function for the abundance module
<code><a href="../reference/ppl_run_pipe_abu1.html">ppl_run_pipe_abu1()</a></code> is executed. This means that if we are
only interested in one species we can go ahead and use the
<code><a href="../reference/ppl_run_pipe_abu1.html">ppl_run_pipe_abu1()</a></code> function, directly.</p>
<p>To run the abundance module of the pipeline, it is enough to just run
(<code><a href="https://rdrr.io/r/base/source.html" class="external-link">source()</a></code>) the script. However, the default values will run
the full pipeline for all species, and for several years, which might
take quite long. We will now go through the different steps of the
pipeline to better understand how to configure it to do what we
want.</p>
<p>Note that while this is the default script we use for running the
pipeline, there is nothing special about it, and we could use something
different that suits our needs. The functionality of the pipeline comes
from its functions.</p>
<div class="section level3">
<h3 id="configuration">Configuration<a class="anchor" aria-label="anchor" href="#configuration"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Configure pipeline</span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/configPipeline.html">configPipeline</a></span><span class="op">(</span></span>
<span>    year <span class="op">=</span> <span class="fl">2021</span>,</span>
<span>    dur <span class="op">=</span> <span class="fl">29</span>,</span>
<span>    mod_file <span class="op">=</span> <span class="st">"cwac_ssm_two_season_mean_rev_jump.R"</span>,</span>
<span>    package <span class="op">=</span> <span class="st">"jagsUI"</span>,</span>
<span>    data_dir <span class="op">=</span> <span class="st">"analysis/data"</span>,     <span class="co"># this might have to be adapted?</span></span>
<span>    out_dir <span class="op">=</span> <span class="st">"analysis/output"</span>,    <span class="co"># this might have to be adapted?</span></span>
<span>    server <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read in catchment data. This should go as an argument</span></span>
<span><span class="va">catchment</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">data_dir</span>, <span class="st">"quinary_catchmt_22.shp"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Re-project and simplify</span></span>
<span><span class="va">catchment</span> <span class="op">&lt;-</span> <span class="va">catchment</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">QUATERNARY</span>, <span class="va">Province</span>, <span class="va">UNIT_ID</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_simplify</a></span><span class="op">(</span>preserveTopology <span class="op">=</span> <span class="cn">TRUE</span>, dTolerance <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>In the configuration section above we will create a
<code>config</code> object using the <code><a href="../reference/configPipeline.html">configPipeline()</a></code>
function that will be used throughout the pipeline by several
functions.</p>
<p>The <code><a href="../reference/configPipeline.html">configPipeline()</a></code> function, allows us to let the
pipeline know what models we want to run, for what years, what packages
we want to use, etc. For detailed information see
<code><a href="../reference/configPipeline.html">?configPipeline</a></code>.</p>
<p>Rather than specifying the covariates that we will use in our models,
like we did for the distribution module, here we only pass the model
file name on to the function. <code><a href="../reference/configPipeline.html">configPipeline()</a></code> will look
for the model file in <code>analysis/models</code>.</p>
<p>The only supported package at the moment is <code>jagsUI</code> and
all package related functions written for BIRDIE are stored in the
<code>R/utils-jags.R</code> file.</p>
<p>(Note: there might be a better way of doing this, such as creating
environment variables or something like this, but this works for
now)</p>
<p>The abundance module allow us to incorporate environmental covariates
into the models, although we are not using any at the moment. When we
use covariates, we do so at the quinary catchment level. So rather than
taking the value of the covariates at some specific location we take the
average value observed across the quinary catchment at some time. We
will see more of this on the <em>BIRDIE ABU: Data preparation</em>
vignette. The important point here is that we need to load the quinary
catchment spatial object here to pass it on to the main pipeline
function, so that it can be used during data preparation (edit the path
to the file).</p>
</div>
<div class="section level3">
<h3 id="create-logs">Create logs<a class="anchor" aria-label="anchor" href="#create-logs"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Create log?</span></span>
<span><span class="fu"><a href="../reference/createLog.html">createLog</a></span><span class="op">(</span><span class="va">config</span>, log_file <span class="op">=</span> <span class="cn">NULL</span>, date_time <span class="op">=</span> <span class="cn">NULL</span>, species <span class="op">=</span> <span class="cn">NA</span>, model <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>          year <span class="op">=</span> <span class="cn">NA</span>, data <span class="op">=</span> <span class="cn">NA</span>, fit <span class="op">=</span> <span class="cn">NA</span>, diagnose <span class="op">=</span> <span class="cn">NA</span>, summary <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>          package <span class="op">=</span> <span class="cn">NA</span>, notes <span class="op">=</span> <span class="st">"Log file created"</span><span class="op">)</span></span></code></pre></div>
<p>The pipeline has a system to log all its activity. This is useful to
keep track of what species and years the pipeline has run for and
whether there have been any problems (e.g., species with too few data
points or model fit errors). All the activity is stored in .csv files
that are saved to <code>analysis/output/reports</code>.</p>
<p>For more information check the logging functions of the BIRDIE
package that are stored on the <code>utils.R</code> file, notably see
<code>?createLog()</code> for general logs and
<code>?logFitStatus()</code> for logs of model runs.</p>
<p>We see that for if we run the pipeline for several species, it makes
sense to create a log file only for the first species, and then use this
file to store information for all other species as well, each one in a
row of the .csv file. Past this first setup phase, the pipeline will
look for the most recent log file and add information to it, regardless
of whether information is already present or not.</p>
</div>
<div class="section level3">
<h3 id="run-modules">Run modules<a class="anchor" aria-label="anchor" href="#run-modules"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">species</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>    <span class="va">sp_code</span> <span class="op">&lt;-</span> <span class="va">config</span><span class="op">$</span><span class="va">species</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Working on species "</span>, <span class="va">sp_code</span>, <span class="st">" ("</span>, <span class="va">i</span>, <span class="st">" of "</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">species</span><span class="op">)</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Run abudance pipeline module 1</span></span>
<span>    <span class="va">status_abu1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ppl_run_pipe_abu1.html">ppl_run_pipe_abu1</a></span><span class="op">(</span><span class="va">sp_code</span>, <span class="va">config</span>,</span>
<span>                                     steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fit"</span>, <span class="st">"diagnose"</span>, <span class="st">"summary"</span><span class="op">)</span>,</span>
<span>                                     prep_data_steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"subset"</span>, <span class="st">"missing"</span>, <span class="st">"gee"</span>, <span class="st">"model"</span><span class="op">)</span>,</span>
<span>                                     summary_scale <span class="op">=</span> <span class="st">"model"</span>,</span>
<span>                                     catchment <span class="op">=</span> <span class="va">catchment</span>,</span>
<span>                                     force_gee_upload <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                     force_gee <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                     monitor <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"ABU1 status ="</span>, <span class="va">status_abu1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The final part of the script runs the main function of the abundance
module of the pipeline, looping through all species. The
<code><a href="../reference/ppl_run_pipe_abu1.html">ppl_run_pipe_abu1()</a></code> can run all the steps of the module:
data preparation, model fitting, model diagnostics and model summary, or
it can run just some of them. It will use the <code>config</code> object
to know what package it should use for model fitting and the paths to
store model-ready data and model outputs. Note that some of the steps,
may take quite long. For example, to prepare data the pipeline connects
to Google Earth Engine and annotates data with environmental covariates,
which can take a while. It also requires an internet connection. Keep
this in mind and note that we can skip some of the steps using the right
arguments. For more information see <code><a href="../reference/ppl_run_pipe_abu1.html">?ppl_run_pipe_abu1</a></code>.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by BIRDIE Development Team.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
