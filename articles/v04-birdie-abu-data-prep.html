<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>BIRDIE ABU: Data preparation • BIRDIE</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="BIRDIE ABU: Data preparation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">BIRDIE</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v01-birdie-basics.html">BIRDIE: Basics</a></li>
    <li><a class="dropdown-item" href="../articles/v02-birdie-spp-abundance.html">BIRDIE: Species abundance</a></li>
    <li><a class="dropdown-item" href="../articles/v03-birdie-spp-distributions.html">BIRDIE: Species distributions</a></li>
    <li><a class="dropdown-item" href="../articles/v04-birdie-abu-data-prep.html">BIRDIE ABU: Data preparation</a></li>
    <li><a class="dropdown-item" href="../articles/v05-birdie-abu-model-fitting.html">BIRDIE ABU: Model fitting</a></li>
    <li><a class="dropdown-item" href="../articles/v06-birdie-abu-model-diagnostics.html">BIRDIE ABU: Model diagnostics</a></li>
    <li><a class="dropdown-item" href="../articles/v07-birdie-abu-model-summary.html">BIRDIE ABU: Model summary</a></li>
    <li><a class="dropdown-item" href="../articles/v08-birdie-dst-data-prep.html">BIRDIE DST: Data preparation</a></li>
    <li><a class="dropdown-item" href="../articles/v09-birdie-dst-model-fitting.html">BIRDIE DST: Model fitting</a></li>
    <li><a class="dropdown-item" href="../articles/v10-birdie-dst-diagnostics.html">BIRDIE DST: Model diagnostics</a></li>
    <li><a class="dropdown-item" href="../articles/v11-birdie-dst-model-summary.html">BIRDIE DST: Model summary</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>BIRDIE ABU: Data preparation</h1>
            
      

      <div class="d-none name"><code>v04-birdie-abu-data-prep.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://africabirddata.github.io/BIRDIE/">BIRDIE</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The species abundance module (ABU) of the BIRDIE pipeline has four
main steps: data preparation, model fitting, model diagnostics and model
summary. See the <em>BIRDIE: basics</em> and <em>BIRDIE: species
abundance</em> vignettes for general details about BIRDIE and about the
ABU module, respectively. In this vignette, we will go through the
different tasks that are performed during the first step of the ABU
module: <strong>data preparation</strong>.</p>
<p>The main function used for data preparation is
<code><a href="../reference/ppl_create_data_ssm.html">ppl_create_data_ssm()</a></code>. This is a <code>ppl_</code>
function, and therefore it doesn’t do much processing itself (see
<em>BIRDIE: basics</em> if this is confusing), but it does call the
right functions to do the work.</p>
<p>Data preparation has three main tasks:</p>
<ul>
<li>Download CWAC data and subset sites suitable for modelling</li>
<li>Complete the dataset by adding missing counts (with NA)</li>
<li>Annotate count data with environmental covariates</li>
<li>Format data for state-space modelling</li>
</ul>
<p>By just running <code><a href="../reference/ppl_create_data_ssm.html">ppl_create_data_ssm()</a></code> all of the tasks
will be performed and our data will be prepared. However, to understand
what goes on “under the hood”, we will explain each of these tasks, and
how they are conducted, below.</p>
<p>Note that data preparation can be time-consuming and it is more
efficient to prepare data for multiple years at once. We are currently
fitting 20 years of data at a time, and so that is the number of years
that will be prepared by <code><a href="../reference/ppl_create_data_ssm.html">ppl_create_data_ssm()</a></code>. The number
of years prepared is given by the <code>dur</code> argument of the
<code><a href="../reference/configPipeline.html">configPipeline()</a></code> function.</p>
</div>
<div class="section level2">
<h2 id="download-cwac-data-and-subset-sites">Download CWAC data and subset sites<a class="anchor" aria-label="anchor" href="#download-cwac-data-and-subset-sites"></a>
</h2>
<p>There is a first section in the <code>ppl_create_ssm_data()</code>
function that run when we tell the function to subset sites or to
complete the dataset with missing counts. In this section we will
download CWAC data using the function
<code><a href="https://rdrr.io/pkg/CWAC/man/getCwacSppCounts.html" class="external-link">CWAC::getCwacSppCounts()</a></code> from the <a href="https://github.com/AfricaBirdData/CWAC" class="external-link"><code>CWAC</code> R
package</a>. We then proceed to include any data that we have and are
not on the CWAC data base. At the moment of writing we have data from
DuToit’s pan contributed by Doug Harebottle. These data is formatted and
incorporated to the data downloaded from CWAC. If we had any other data
we wanted to include we would need to modify this part of the
<code><a href="../reference/ppl_create_data_ssm.html">ppl_create_data_ssm()</a></code> function code.</p>
<p>Once all of the data is combined we subset those sites that have been
counted at least five times during summer and five times during winter
between the years 1993 and 2021. Those species that don’t meet the
requirements should be analysed differently, although we still don’t
have an alternative model for them. During model diagnosis there is
another filter where model outputs with too large of a difference
between the estimates and the upper limit of the credible intervals are
also discarded (see BIRDIE ABU: Model diagnostics).</p>
</div>
<div class="section level2">
<h2 id="adding-missing-counts">Adding missing counts<a class="anchor" aria-label="anchor" href="#adding-missing-counts"></a>
</h2>
<p>When data comes out of the CWAC database there is no reference to
missing counts, meaning that if in any year nobody went to count a
certain wetland during a certain season this data point would just be
absent from the data set. What we would like instead is a record for
that season and year with a missing (<code>NA</code>) count. This is
convenient for multiple reasons, but perhaps the most important one is
that <code>JAGS</code> will automatically treat these missing data
points as parameters that need to be estimated. We give missing summer
counts a date that corresponds to the first day of January (perhaps we
should reconsider this, because summer counts only start on the 15th of
January) and to winter counts we assign the first of July.</p>
</div>
<div class="section level2">
<h2 id="annotate-with-environmental-covariates">Annotate with environmental covariates<a class="anchor" aria-label="anchor" href="#annotate-with-environmental-covariates"></a>
</h2>
<p>Although we are not currently using covariates in our modelling, we
may use environmental covariates to model abundance, which requires
count data to be annotated with this information. To facilitate the
automation of this process and periodic updates when new data becomes
available, we use the data sets and functionality offered by Google
Earth Engine (GEE).</p>
<p>The functionality to connect and transfer data to/from GEE is
provided by the <a href="https://github.com/AfricaBirdData/ABDtools" class="external-link"><code>ABDtools</code>
R package</a>. This package basically wraps functions from <a href="https://github.com/r-spatial/rgee" class="external-link"><code>rgee</code></a>; another
package on which it depends heavily. Therefore, it is a requirement to
have <code>rgee</code> properly installed and configured to be able to
perform data-annotation tasks. Check the GitHub repos for <a href="https://github.com/r-spatial/rgee" class="external-link"><code>rgee</code></a> and <a href="https://github.com/AfricaBirdData/ABDtools" class="external-link"><code>ABDtools</code></a>.</p>
<p>Once these two packages are installed and configured, we can use
their functionality in the pipeline. In BIRDIE we use the function
<code><a href="../reference/prepGEECatchmData.html">prepGEECatchmData()</a></code> to annotate CWAC data. See
<code>?prepGEECatchmData()</code> for details. The function makes
reference to “catchment” because at the moment this function is prepared
to use the quinary catchment CWAC sites are located at as a reference
area for the covariates. So rather than extracting environmental
information from some specific point location, we extract all pixels
contained in the quinary catchment and we take the average value of the
covariate across those pixels.</p>
<p>Annotating with different variables using GEE requires different
procedures. Therefore, there is no way to flexibly communicate to these
functions which variables we want to annotate our data with. Instead, we
have <strong>hard-coded</strong> the variables we are using for the
BIRDIE pipeline. If we wanted to change the variables we use, then we
would have to modify the <code><a href="../reference/prepGEECatchmData.html">prepGEECatchmData()</a></code> function. This
is not ideal, but it is how it is set up currently.</p>
<p>One important thing to keep in mind is that we consider that
waterbird summer populations should be affected by the environmental
conditions of the previous year, rather than on the same year. This is
because summer occur in January and therefore the average conditions on
the previous year are likely to affect summer populations more directly
than those on the same year, which have still not presented themselves
at the time of counting.</p>
<p>Another important thing to keep in mind is that some environmental
layers used don’t have information past a certain date. We have set up
the functions in such a way that data past the last date of the layer
get annotated with the latest available information (last date of the
layer). Whenever the pipeline is run it is advised to review the
environmental layer used and the last date information is available for,
and update the functions if necessary.</p>
</div>
<div class="section level2">
<h2 id="format-data-for-state-space-modelling">Format data for state-space modelling<a class="anchor" aria-label="anchor" href="#format-data-for-state-space-modelling"></a>
</h2>
<p>In a final step we prepare the data for modelling. We will not format
it to fit into any specific package yet. Here we create certain
variables that are useful such as ids for site, year and visit.</p>
<p>Very importantly, here there is a choice to make in terms of what to
do when seasonal counts are duplicated. For now, we keep all counts that
are labelled as <code>summer</code> or <code>winter</code> counts in the
CWAC data and consider them to be replicates.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by BIRDIE Development Team.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
