<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>BIRDIE DST: Data preparation • BIRDIE</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="BIRDIE DST: Data preparation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">BIRDIE</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v01-birdie-basics.html">BIRDIE: Basics</a></li>
    <li><a class="dropdown-item" href="../articles/v02-birdie-spp-abundance.html">BIRDIE: Species abundance</a></li>
    <li><a class="dropdown-item" href="../articles/v03-birdie-spp-distributions.html">BIRDIE: Species distributions</a></li>
    <li><a class="dropdown-item" href="../articles/v04-birdie-abu-data-prep.html">BIRDIE ABU: Data preparation</a></li>
    <li><a class="dropdown-item" href="../articles/v05-birdie-abu-model-fitting.html">BIRDIE ABU: Model fitting</a></li>
    <li><a class="dropdown-item" href="../articles/v06-birdie-abu-model-diagnostics.html">BIRDIE ABU: Model diagnostics</a></li>
    <li><a class="dropdown-item" href="../articles/v07-birdie-abu-model-summary.html">BIRDIE ABU: Model summary</a></li>
    <li><a class="dropdown-item" href="../articles/v08-birdie-dst-data-prep.html">BIRDIE DST: Data preparation</a></li>
    <li><a class="dropdown-item" href="../articles/v09-birdie-dst-model-fitting.html">BIRDIE DST: Model fitting</a></li>
    <li><a class="dropdown-item" href="../articles/v10-birdie-dst-diagnostics.html">BIRDIE DST: Model diagnostics</a></li>
    <li><a class="dropdown-item" href="../articles/v11-birdie-dst-model-summary.html">BIRDIE DST: Model summary</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>BIRDIE DST: Data preparation</h1>
            
      

      <div class="d-none name"><code>v08-birdie-dst-data-prep.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The species distributions module (DST) of the BIRDIE pipeline has
four main steps: data preparation, model fitting, model diagnostics and
model summary. See the <em>BIRDIE: basics</em> and <em>BIRDIE: species
distributions</em> vignettes for general details about BIRDIE and about
the DST module, respectively. In this vignette, we will go through the
different tasks that are performed during the first step of the DST
module: <strong>data preparation</strong>.</p>
<p>The main function used for data preparation is
<code><a href="../reference/ppl_create_site_visit.html">ppl_create_site_visit()</a></code>. This is a <code>ppl_</code>
function, and therefore it doesn’t do much processing itself (see
<em>BIRDIE: basics</em> if this is confusing), but it does call the
right functions to do the work.</p>
<p>Its name makes reference to <em>site</em> and <em>visit</em> because
it will create two separate datasets from <a href="https://www.birdmap.africa/" class="external-link">ABAP</a> data: one with one entry for
each site (pentad) visited, and one with one entry for each visit
conducted (i.e., pentads can be visited more than once). In fact, this
function will create a third dataset. For any particular year, sites and
visits will be common for all species, so we need a third dataset with
the detection information for each species.</p>
<p>Data preparation has three main tasks:</p>
<ul>
<li>Download ABAP data</li>
<li>Annotate site and visit data with environmental covariates</li>
<li>Format site, visit and detection data</li>
</ul>
<p>By just running <code><a href="../reference/ppl_create_site_visit.html">ppl_create_site_visit()</a></code> all of the tasks
will be performed and our data will be prepared. However, to understand
what goes on “under the hood”, we will explain each of these tasks, and
how they are conducted, below.</p>
<p>Note that data preparation can be time-consuming and it is more
efficient to prepare data for multiple years at once. Therefore, while
occupancy models are run for one year at a time, data preparation is
done for several years at once. The number of years prepared is given by
the <code>dur</code> argument of the <code><a href="../reference/configPipeline.html">configPipeline()</a></code>
function. This means that we don’t need to prepare data every time the
pipeline runs. For example, the piece of code below would configure the
pipeline to prepare data for the years 2008, 2009, 2010, because we set
<code>year = 2010</code> and <code>dur = 3</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/configPipeline.html">configPipeline</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2010</span>,</span>
<span>                         dur <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                         occ_mod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"log_dist_coast"</span>, <span class="st">"elev"</span><span class="op">)</span>,</span>
<span>                         det_mod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"log_hours"</span><span class="op">)</span>,</span>
<span>                         fixed_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dist_coast"</span>, <span class="st">"elev"</span><span class="op">)</span>,</span>
<span>                         package <span class="op">=</span> <span class="st">"spOccupancy"</span>,</span>
<span>                         data_dir <span class="op">=</span> <span class="st">"analysis/data"</span>,</span>
<span>                         out_dir <span class="op">=</span> <span class="st">"analysis/output"</span>,</span>
<span>                         server <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Then, the main pipeline function <code><a href="../reference/ppl_run_pipe_dst1.html">ppl_run_pipe_dst1()</a></code>
gives us the option to select which year we want to run models for with
the argument <code>year</code> and we may skip data preparation by
setting <code>force_gee_dwld = FALSE</code>,
<code>force_site_visit = FALSE</code>, like so</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ppl_run_pipe_dst1.html">ppl_run_pipe_dst1</a></span><span class="op">(</span>sp_code <span class="op">=</span> <span class="va">sp_code</span>,</span>
<span>                  year <span class="op">=</span> <span class="fl">2008</span>, <span class="co"># this is the year models will run for</span></span>
<span>                  config <span class="op">=</span> <span class="va">config</span>,</span>
<span>                  steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"data"</span><span class="op">)</span>,</span>
<span>                  force_gee_dwld <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  monitor_gee <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                  force_site_visit <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                  force_abap_dwld <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  spatial <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  print_fitting <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>See more explanations about what <em>gee</em> and <em>site_visit</em>
mean below.</p>
</div>
<div class="section level2">
<h2 id="download-abap-data">Download ABAP data<a class="anchor" aria-label="anchor" href="#download-abap-data"></a>
</h2>
<p>This process is facilitated by the use of the <a href="https://github.com/AfricaBirdData/ABAP" class="external-link"><code>ABAP</code> R
package</a>.</p>
<p>There isn’t much to say that is not explained on the GitHub
repository of the ABAP package (check it out).</p>
<p>We will need to call the functions <code><a href="https://rdrr.io/pkg/ABAP/man/getAbapData.html" class="external-link">ABAP::getAbapData()</a></code>
and <code><a href="https://rdrr.io/pkg/ABAP/man/getRegionPentads.html" class="external-link">ABAP::getRegionPentads()</a></code> several times during the data
preparation process.</p>
</div>
<div class="section level2">
<h2 id="annotate-with-environmental-covariates">Annotate with environmental covariates<a class="anchor" aria-label="anchor" href="#annotate-with-environmental-covariates"></a>
</h2>
<p>We use environmental covariates to model occupancy and detection
probabilities, which requires detection/non-detection data to be
annotated with this information. To facilitate the automation of this
process and periodic updates when new data becomes available, we use the
datasets and functionality offered by Google Earth Engine (GEE).</p>
<p>The functionality to connect and transfer data to/from GEE is
provided by the <a href="https://github.com/AfricaBirdData/ABDtools" class="external-link"><code>ABDtools</code>
R package</a>. This package basically wraps functions from <a href="https://github.com/r-spatial/rgee" class="external-link"><code>rgee</code></a>; another
package on which it depends heavily. Therefore, it is a requirement to
have <code>rgee</code> properly installed and configured to be able to
perform data-annotation tasks. Check the GitHub repos for <a href="https://github.com/r-spatial/rgee" class="external-link"><code>rgee</code></a> and <a href="https://github.com/AfricaBirdData/ABDtools" class="external-link"><code>ABDtools</code></a>.</p>
<p>Once these two packages are installed and configured, we can use
their functionality in the pipeline. There are two functions in BIRDIE
that are used to annotate ABAP data: <code><a href="../reference/prepGEESiteData.html">prepGEESiteData()</a></code> and
<code><a href="../reference/prepGEEVisitData.html">prepGEEVisitData()</a></code>, which are used to annotate site and
visit data, respectively. See <code>?prepGEESiteData()</code> and
<code>?prepGEEVisitData()</code> for details. All GEE related functions
have been packaged in the file <code>R/utils-gee.R</code></p>
<p>Annotating with different variables using GEE require different
procedures. Therefore, there is no way to flexibly communicate to these
functions which variables we want to annotate our data with. Instead, we
have <strong>hard-coded</strong> the variables we are using for the
BIRDIE pipeline. If we wanted to change the variables we use, then we
would have to modify the <code><a href="../reference/prepGEESiteData.html">prepGEESiteData()</a></code> and
<code><a href="../reference/prepGEEVisitData.html">prepGEEVisitData()</a></code> functions. This is not ideal, but it is
how it is set up currently. We also have to keep this in mind when we
pass the covariates we want to use in the models to the
<code><a href="../reference/configPipeline.html">configPipeline()</a></code> function in the control script (see
<em>BIRDIE-spp-distributions</em>). These covariates must be among those
provided by <code><a href="../reference/prepGEESiteData.html">prepGEESiteData()</a></code> and
<code><a href="../reference/prepGEEVisitData.html">prepGEEVisitData()</a></code> and have the same names.</p>
<p>Another important thing to keep in mind is that some environmental
layers used don’t have information past a certain date. We have set up
the functions in such a way that data past the last date of the layer
get annotated with the latest available information (last date of the
layer). Whenever the pipeline is run it is advised to review the
environmental layer used and the last date information is available for,
and update the functions if necessary.</p>
<p>This now brings us to the next part of the data preparation, which is
the formatting of site, visit and detection data.</p>
</div>
<div class="section level2">
<h2 id="format-site-visit-and-detection-data">Format site, visit and detection data<a class="anchor" aria-label="anchor" href="#format-site-visit-and-detection-data"></a>
</h2>
<p>In the last step of data preparation, we need to take the data coming
out of GEE and reformat it for occupancy modelling. Note that at this
stage the data will not be formatted for any particular package, they
will just take a good starting point for being used for occupancy
modelling. The function we use for this is
<code><a href="../reference/createOccuData.html">createOccuData()</a></code>.</p>
<p>Here, we create site and visit data frames that have the covariates
specified in <code><a href="../reference/configPipeline.html">configPipeline()</a></code>. Data coming from GEE will be
in a wide format, meaning that each variable and year will be in a
separate column. In general, we would like variables to be in one column
and years in another column. This is one of the important tasks
<code><a href="../reference/createOccuData.html">createOccuData()</a></code> will do for us. We also use this function
to create transformations of those variables coming from GEE (e.g. we
sometimes use log transformations) and interactions.
<strong><code><a href="../reference/createOccuData.html">createOccuData()</a></code> is also hard-coded</strong>, so if
we decide to use some new variable transformation, we need to modify
this function to create it explicitly. Interactions should be handled
correctly as long as the variables involved in the interaction are
present in the data.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by BIRDIE Development Team.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
